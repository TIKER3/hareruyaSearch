<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åº—èˆ—æ¤œç´¢ | URLã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f8fafc;
      --panel: #ffffff;
      --text-main: #334155;
      --text-sub: #64748b;
      --accent: #0ea5e9;
      --accent-hover: #0284c7;
      --border: #e2e8f0;
      --input-bg: #ffffff;
      --focus-ring: rgba(14, 165, 233, 0.25);
      
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: "Inter", "Noto Sans JP", sans-serif;
      background-color: var(--bg);
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(14, 165, 233, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(14, 165, 233, 0.05) 0%, transparent 20%);
      color: var(--text-main);
      min-height: 100vh;
      line-height: 1.5;
    }

    .page {
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 20px 80px;
    }

    header {
      text-align: center;
      margin-bottom: 32px;
    }
    header h1 {
      margin: 0 0 12px;
      font-weight: 800;
      color: #0f172a;
      letter-spacing: -0.025em;
      font-size: 1.75rem;
    }
    .lede {
      color: var(--text-sub);
      margin: 0;
      font-size: 0.95rem;
    }

    .grid {
      display: grid;
      gap: 24px;
      grid-template-columns: 1fr; 
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-md);
      transition: box-shadow 0.2s ease;
    }

    label {
      display: block;
      font-weight: 700;
      margin-bottom: 8px;
      color: #1e293b;
      font-size: 0.95rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: 16px;
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
    }
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    button {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 16px;
      background: #ffffff;
      color: var(--text-main);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-width: 80px; /* ãƒœã‚¿ãƒ³ã®å¹…ãŒå¤‰å‹•ã—ã™ããªã„ã‚ˆã†ã« */
    }
    button:hover {
      background-color: #f1f5f9;
      transform: translateY(-1px);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    button.primary {
      background: var(--accent);
      color: #ffffff;
      border: 1px solid transparent;
      box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3);
    }
    button.primary:hover {
      background: var(--accent-hover);
    }

    button.action-copy {
      color: var(--accent);
      border-color: #bae6fd;
      background: #f0f9ff;
    }
    button.action-copy:hover {
      background: #e0f2fe;
    }
    
    /* ä½ç½®æƒ…å ±ãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    button.location-btn {
      color: #059669;
      border-color: #a7f3d0;
      background: #ecfdf5;
      min-width: 140px; /* ãƒ†ã‚­ã‚¹ãƒˆãŒå¤‰ã‚ã£ã¦ã‚‚ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œã‚’é˜²ã */
    }
    button.location-btn:hover {
      background: #d1fae5;
    }
    /* æˆåŠŸæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    button.location-btn.success {
      background: #22c55e;
      color: white;
      border-color: #22c55e;
    }

    #radiusSelect {
      height: 32px;
      padding: 0 4px 0 8px;
      border: 1px solid #a7f3d0;
      background: #ecfdf5;
      color: #059669;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 4px;
    }
    #radiusSelect:focus {
      outline: 2px solid #059669;
      outline-offset: 1px;
    }

    iframe.preview {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      min-height: 300px;
      background: #f1f5f9;
    }

    .muted {
      color: var(--text-sub);
      font-size: 0.85rem;
      margin-top: 16px;
      line-height: 1.6;
    }

    /* åº—èˆ—é¸æŠã‚¨ãƒªã‚¢ */
    .store-selection {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    .store-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .store-header label { margin: 0; }
    
    .store-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .store-buttons button {
      font-size: 0.75rem;
      padding: 4px 10px;
      height: 32px;
    }

    .store-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px;
      max-height: 280px;
      overflow-y: auto;
      padding: 12px;
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    
    .store-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px;
      border-radius: 6px;
      transition: background 0.15s;
    }
    .store-item:hover {
      background: #e2e8f0;
    }
    .store-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--accent);
      border-color: #cbd5e1;
    }
    .store-item label {
      cursor: pointer;
      font-weight: 500;
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-main);
      user-select: none;
      flex: 1;
    }

    /* ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ */
    .options-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }
    .option-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .option-group label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-sub);
    }
    .option-group select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text-main);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .checkbox-option {
      display: flex;
      align-items: center;
      gap: 8px;
      height: 42px;
    }
    .checkbox-option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--accent);
    }
    .checkbox-option label {
      cursor: pointer;
      font-weight: 600;
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    @media (max-width: 640px) {
      .page { padding: 20px 16px; }
      header h1 { font-size: 1.4rem; }
      .store-grid { grid-template-columns: repeat(2, 1fr); }
      .options-grid { grid-template-columns: 1fr; }
      .buttons { flex-direction: column; }
      .buttons button { width: 100%; }
      .store-header { align-items: flex-start; flex-direction: column; }
      .store-buttons { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>åº—èˆ—æ¤œç´¢ URL ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
      <p class="lede">
        ã‚«ãƒ¼ãƒ‰åã‚’å…¥åŠ›ã™ã‚‹ã¨ã€å„åº—èˆ—ã®æ¤œç´¢URLã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã™ã€‚
      </p>
    </header>

    <div class="grid">
      <section class="card">
        <label for="cardName">æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ¼ãƒ‰åï¼‰</label>
        <input id="cardName" type="text" placeholder="ä¾‹: ç¨²å¦» / Lightning Bolt" autocomplete="off" />
        
        <div class="store-selection">
          <div class="store-header">
            <label>å¯¾è±¡åº—èˆ—</label>
            <div class="store-buttons">
              <div style="display:flex; align-items:center;">
                <select id="radiusSelect">
                  <option value="1">1kmä»¥å†…</option>
                  <option value="3">3kmä»¥å†…</option>
                  <option value="5" selected>5kmä»¥å†…</option>
                  <option value="7">7kmä»¥å†…</option>
                  <option value="10">10kmä»¥å†…</option>
                  <option value="20">20kmä»¥å†…</option>
                </select>
                <button id="locationBtn" class="location-btn">
                  <span id="locIcon">ğŸ“</span> <span id="locText">ç¾åœ¨åœ°ã‹ã‚‰</span>
                </button>
              </div>
              
              <button id="selectAllBtn" style="margin-left:4px;">å…¨ã¦</button>
              <button id="deselectAllBtn">è§£é™¤</button>
            </div>
          </div>
          <div class="store-grid" id="storeGrid"></div>
        </div>

        <div class="options-section">
          <div class="options-grid">
            <div class="option-group">
              <label for="stockOption">åœ¨åº«çŠ¶æ³</label>
              <select id="stockOption">
                <option value="">æŒ‡å®šãªã—</option>
                <option value="1">åœ¨åº«ã‚ã‚Š</option>
              </select>
            </div>
            <div class="option-group">
              <label for="languageOption">è¨€èª</label>
              <select id="languageOption">
                <option value="">æŒ‡å®šãªã—</option>
                <option value="1">æ—¥æœ¬èª</option>
                <option value="2">è‹±èª</option>
              </select>
            </div>
            <div class="option-group">
              <label>ãã®ä»–ã®æ¡ä»¶</label>
              <div class="checkbox-option">
                <input type="checkbox" id="foilOption" />
                <label for="foilOption">Foilã®ã¿</label>
              </div>
            </div>
          </div>
        </div>

        <div class="buttons">
          <button class="primary" id="generateBtn">URLã‚’ä½œæˆ</button>
          <button class="action-copy" id="copyResultBtn">URLä¸€è¦§ã‚’ã‚³ãƒ”ãƒ¼</button>
          <button id="sampleBtn">ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›</button>
          <button id="clearBtn">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <p class="muted">
          â€»ã€Œç¾åœ¨åœ°ã‹ã‚‰ã€ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±è¨±å¯ãŒå¿…è¦ã§ã™ã€‚<br>
          â€»ã€ŒURLã‚’ä½œæˆã€ã‚’æŠ¼ã™ã¨ä¸‹ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        </p>
      </section>

      <div class="card">
        <h2 style="margin:0 0 16px; font-size:1.1rem; color:#0f172a;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <iframe id="preview" class="preview" title="ç”ŸæˆHTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"></iframe>
      </div>
    </div>

    <footer style="margin-top: 40px; border-top: 1px solid var(--border); padding-top: 20px; text-align: center; font-size: 0.75rem; color: var(--text-sub);">
      <p>åº—èˆ—æ¤œç´¢ URL ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ is unofficial Fan Content permitted under the Fan Content Policy. Not approved/endorsed by Wizards. Portions of the materials used are property of Wizards of the Coast. Â©Wizards of the Coast LLC.</p>
    </footer>

  </div>

  <script>
    // 1. åº—èˆ—ãƒªã‚¹ãƒˆå®šç¾©
    const stores = [
      "TCæ±äº¬", "ç§‹è‘‰åŸ", "æ¸‹è°·", "å‰ç¥¥å¯º", "åƒè‘‰", "æˆç”°", "å¤§å®®", "å·å´",
      "æ¨ªæµœ", "ç”ºç”°", "æœ­å¹Œ", "ä»™å°", "éƒ¡å±±", "é«˜å´", "å®‡éƒ½å®®", "æ°´æˆ¸",
      "æ–°æ½Ÿ", "é‡‘æ²¢", "ç”²åºœ", "é™å²¡", "åå¤å±‹","å¤§é ˆ", "TCå¤§é˜ª", "æ—¥æœ¬æ©‹", "ä¸‰å®®",
      "äº¬éƒ½","åºƒå³¶", "é«˜æ¾", "ç¦å²¡"
    ];

    // åº—èˆ—ã®åº§æ¨™ãƒ‡ãƒ¼ã‚¿
    const storeLocations = {
      "TCæ±äº¬": { lat: 35.7145, lng: 139.7046 }, // é«˜ç”°é¦¬å ´
      "ç§‹è‘‰åŸ": { lat: 35.7022, lng: 139.7741 },
      "æ¸‹è°·": { lat: 35.6580, lng: 139.7016 },
      "å‰ç¥¥å¯º": { lat: 35.7022, lng: 139.5794 },
      "åƒè‘‰": { lat: 35.6131, lng: 140.1132 },
      "æˆç”°": { lat: 35.7766, lng: 140.3187 },
      "å¤§å®®": { lat: 35.9063, lng: 139.6240 },
      "å·å´": { lat: 35.5304, lng: 139.7005 },
      "æ¨ªæµœ": { lat: 35.4657, lng: 139.6223 },
      "ç”ºç”°": { lat: 35.5407, lng: 139.4442 },
      "æœ­å¹Œ": { lat: 43.0618, lng: 141.3545 },
      "ä»™å°": { lat: 38.2601, lng: 140.8824 },
      "éƒ¡å±±": { lat: 37.3996, lng: 140.3888 },
      "é«˜å´": { lat: 36.3223, lng: 139.0125 },
      "å®‡éƒ½å®®": { lat: 36.5551, lng: 139.8828 },
      "æ°´æˆ¸": { lat: 36.3703, lng: 140.4578 },
      "æ–°æ½Ÿ": { lat: 37.9138, lng: 139.0624 },
      "é‡‘æ²¢": { lat: 36.5780, lng: 136.6482 },
      "ç”²åºœ": { lat: 35.6621, lng: 138.5683 },
      "é™å²¡": { lat: 34.9756, lng: 138.3828 },
      "åå¤å±‹": { lat: 35.1709, lng: 136.8815 },
      "å¤§é ˆ": { lat: 35.1595, lng: 136.9056 },
      "TCå¤§é˜ª": { lat: 34.7035, lng: 135.4965 }, 
      "æ—¥æœ¬æ©‹": { lat: 34.6596, lng: 135.5065 },
      "ä¸‰å®®": { lat: 34.6946, lng: 135.1956 },
      "äº¬éƒ½": { lat: 35.0037, lng: 135.7686 },
      "åºƒå³¶": { lat: 34.3963, lng: 132.4594 },
      "é«˜æ¾": { lat: 34.3398, lng: 134.0470 },
      "ç¦å²¡": { lat: 33.5902, lng: 130.3989 } 
    };

    const storeGrid = document.getElementById("storeGrid");
    
    // åº—èˆ—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ç”Ÿæˆãƒ«ãƒ¼ãƒ—
    if (storeGrid) {
        stores.forEach(store => {
          const item = document.createElement("div");
          item.className = "store-item";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `store-${store}`;
          checkbox.value = store;
          const label = document.createElement("label");
          label.htmlFor = `store-${store}`;
          label.textContent = store;
          item.appendChild(checkbox);
          item.appendChild(label);
          storeGrid.appendChild(item);
        });
    }

    // å¤‰æ•°å®šç¾©
    const cardNameInput = document.getElementById("cardName");
    const preview = document.getElementById("preview");
    const generateBtn = document.getElementById("generateBtn");
    const sampleBtn = document.getElementById("sampleBtn");
    const clearBtn = document.getElementById("clearBtn");
    const copyResultBtn = document.getElementById("copyResultBtn");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const deselectAllBtn = document.getElementById("deselectAllBtn");
    const locationBtn = document.getElementById("locationBtn");
    const radiusSelect = document.getElementById("radiusSelect");

    let generatedUrlText = "";
    const STORAGE_KEY = "hareruyaSearchState_v5";

    const storeSlugs = {
      "ç§‹è‘‰åŸ": "akihabara",
      "æ¸‹è°·": "shibuya",
      "å‰ç¥¥å¯º": "kichijoji",
      "åƒè‘‰": "chiba",
      "æˆç”°": "narita",
      "å¤§å®®": "omiya",
      "å·å´": "kawasaki",
      "æ¨ªæµœ": "yokohama",
      "ç”ºç”°": "machida",
      "æœ­å¹Œ": "sapporo",
      "ä»™å°": "koriyama",
      "éƒ¡å±±": "koriyama",
      "é«˜å´": "takasaki",
      "å®‡éƒ½å®®": "utsunomiya",
      "æ°´æˆ¸": "mito",
      "æ–°æ½Ÿ": "niigata",
      "é‡‘æ²¢": "kanazawa",
      "ç”²åºœ": "kofu",
      "é™å²¡": "shizuoka",
      "åå¤å±‹": "nagoya",
      "å¤§é ˆ": "osu",      
      "TCå¤§é˜ª": "osaka",
      "æ—¥æœ¬æ©‹": "nipponbashi",
      "ä¸‰å®®": "sannomiya",
      "äº¬éƒ½": "kyoto",
      "åºƒå³¶": "hiroshima",
      "é«˜æ¾": "takamatsu",
      "ç¦å²¡": "fukuoka"
    };

    const saveState = (value) => {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(value)); } catch (e) {}
    };

    const loadState = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch (e) { return null; }
    };

    const clearState = () => { localStorage.removeItem(STORAGE_KEY); };

    const escapeHtml = (text) =>
      text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");

    const buildUrl = (cardName, store = null) => {
      const query = encodeURIComponent(cardName);
      const params = [`product=${query}`];
      
      const stockOption = document.getElementById("stockOption").value;
      if (stockOption !== "") params.push(`stock=${stockOption}`);
      
      const languageOption = document.getElementById("languageOption").value;
      if (languageOption !== "") params.push(`language%5B%5D=${languageOption}`);
      
      const foilOption = document.getElementById("foilOption").checked;
      if (foilOption) params.push(`foilFlg%5B%5D=1`);
      
      const queryString = params.join("&");
      
      if (!store || store === "TCæ±äº¬") return `https://www.hareruyamtg.com/ja/products/search?${queryString}`;
      const slug = storeSlugs[store];
      return slug ? `https://shops.hareruyamtg.com/${slug}/products/search/result/?${queryString}` : `https://www.hareruyamtg.com/ja/products/search?${queryString}`;
    };

    const getSelectedStores = () => {
      return stores.filter(store => {
         const el = document.getElementById(`store-${store}`);
         return el && el.checked;
      });
    };

    const render = () => {
      const cardName = cardNameInput.value.trim();
      if (!cardName) {
        generatedUrlText = "";
        preview.srcdoc = "";
        return;
      }
      
      const selectedStores = getSelectedStores();
      if (selectedStores.length === 0) {
        generatedUrlText = "";
        preview.srcdoc = "";
        return;
      }

      const urls = selectedStores.map(store => ({ store, url: buildUrl(cardName, store) }));
      generatedUrlText = urls.map(item => `${item.url}`).join("\n");

      const previewHtml = `<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { 
    margin: 0; 
    background: #f8fafc; 
    color: #334155; 
    font-family: "Inter", sans-serif; 
    padding: 16px; 
  }
  a { 
    color: #0ea5e9; 
    word-break: break-all; 
    text-decoration: none; 
    font-size: 0.9rem;
  }
  a:hover { text-decoration: underline; }
  .item { 
    margin-bottom: 12px; 
    padding: 12px; 
    background: #ffffff; 
    border-radius: 8px; 
    border: 1px solid #e2e8f0; 
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  }
  .store { 
    margin: 0 0 4px; 
    font-weight: 700; 
    color: #0f172a; 
    font-size: 0.85rem;
  }
  .count { font-size: 0.85rem; font-weight: bold; margin-bottom: 12px; color: #64748b; }
</style>
</head>
<body>
  <div class="count">ç”Ÿæˆçµæœ: ${urls.length}ä»¶</div>
  ${urls.map(item => `
    <div class="item">
      <div class="store">${escapeHtml(item.store)}</div>
      <a href="${escapeHtml(item.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(item.url)}</a>
    </div>
  `).join("")}
</body>
</html>`;
      preview.srcdoc = previewHtml;

      const state = {
        cardName,
        stores: selectedStores,
        stock: document.getElementById("stockOption").value,
        language: document.getElementById("languageOption").value,
        foil: document.getElementById("foilOption").checked
      };
      saveState(state);
    };

    // ----------------------------------------------------
    // ä½ç½®æƒ…å ±æ©Ÿèƒ½ã®ãƒ­ã‚¸ãƒƒã‚¯ (ä¿®æ­£ç‰ˆ)
    // ----------------------------------------------------
    const getDistanceFromLatLonInKm = (lat1, lon1, lat2, lon2) => {
      const R = 6371; 
      const dLat = (lat2 - lat1) * (Math.PI / 180);
      const dLon = (lon2 - lon1) * (Math.PI / 180);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; 
    };

    locationBtn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      // è¦ç´ ã®å–å¾—ã¨å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
      const icon = document.getElementById("locIcon");
      const text = document.getElementById("locText");
      
      // ãƒœã‚¿ãƒ³ãŒæ—¢ã«å‡¦ç†ä¸­(è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãªã©)ã®å ´åˆã¯ã‚¬ãƒ¼ãƒ‰
      if (!icon || !text) {
        // ä¸‡ãŒä¸€HTMLãŒå£Šã‚Œã¦ã„ãŸå ´åˆã®å¾©æ—§
        locationBtn.innerHTML = '<span id="locIcon">ğŸ“</span> <span id="locText">ç¾åœ¨åœ°ã‹ã‚‰</span>';
        return;
      }

      // UIã‚’ãƒ­ãƒ¼ãƒ‰ä¸­ã«å¤‰æ›´
      locationBtn.disabled = true;
      icon.textContent = "â³";
      text.textContent = "æ¤œç´¢ä¸­...";
      
      // æˆåŠŸæ™‚ã®å‡¦ç†ãªã©ã«ã‚ˆã‚‹ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ã‚’ãƒªã‚»ãƒƒãƒˆ
      locationBtn.classList.remove("success");

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          const radiusVal = document.getElementById("radiusSelect").value;
          const RADIUS_KM = parseFloat(radiusVal);
          
          let foundCount = 0;

          // 1. å…¨è§£é™¤
          stores.forEach(store => {
            const el = document.getElementById(`store-${store}`);
            if(el) el.checked = false;
          });

          // 2. è·é›¢åˆ¤å®šã¨ãƒã‚§ãƒƒã‚¯
          stores.forEach(store => {
            const loc = storeLocations[store];
            if (loc) {
              const distance = getDistanceFromLatLonInKm(userLat, userLng, loc.lat, loc.lng);
              if (distance <= RADIUS_KM) {
                const el = document.getElementById(`store-${store}`);
                if (el) {
                  el.checked = true;
                  foundCount++;
                }
              }
            }
          });

          // 3. ãƒœã‚¿ãƒ³çŠ¶æ…‹ã®å¾©å¸°
          locationBtn.disabled = false;
          locationBtn.classList.add("success");
          icon.textContent = "âœ…";
          
          if (foundCount > 0) {
             text.textContent = `${foundCount}åº—èˆ—é¸æŠ`;
          } else {
             text.textContent = "ãªã—";
             alert(`ç¾åœ¨åœ°ã‹ã‚‰${RADIUS_KM}kmä»¥å†…ã«åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
          }

          // 1.5ç§’å¾Œã«å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã«æˆ»ã™
          setTimeout(() => {
            // è¦ç´ ãŒã¾ã å­˜åœ¨ã™ã‚‹ã‹ç¢ºèªï¼ˆé€£æ‰“ãªã©ã§æ¶ˆãˆã¦ã„ã‚‹å¯èƒ½æ€§ã¸ã®å¯¾ç­–ï¼‰
            const i = document.getElementById("locIcon");
            const t = document.getElementById("locText");
            if (i && t) {
              i.textContent = "ğŸ“";
              t.textContent = "ç¾åœ¨åœ°ã‹ã‚‰";
              locationBtn.classList.remove("success");
            }
          }, 1500);
        },
        (error) => {
          console.error(error);
          locationBtn.disabled = false;
          const i = document.getElementById("locIcon");
          const t = document.getElementById("locText");
          if (i && t) {
            i.textContent = "ğŸ“";
            t.textContent = "ç¾åœ¨åœ°ã‹ã‚‰";
          }
          alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        },
        // ä½ç½®æƒ…å ±ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã›ãšã€æœ€æ–°ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0 
        }
      );
    });

    // ----------------------------------------------------

    selectAllBtn.addEventListener("click", () => {
      stores.forEach(store => {
        const el = document.getElementById(`store-${store}`);
        if(el) el.checked = true;
      });
    });

    deselectAllBtn.addEventListener("click", () => {
      stores.forEach(store => {
        const el = document.getElementById(`store-${store}`);
        if(el) el.checked = false;
      });
    });

    generateBtn.addEventListener("click", render);
    cardNameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        render();
      }
    });

    sampleBtn.addEventListener("click", () => {
      cardNameInput.value = "æ€è€ƒå›²ã„ / Thoughtseize";
      render();
    });

    clearBtn.addEventListener("click", () => {
      cardNameInput.value = "";
      stores.forEach(store => {
        const el = document.getElementById(`store-${store}`);
        if(el) el.checked = false;
      });
      document.getElementById("stockOption").value = "";
      document.getElementById("languageOption").value = "";
      document.getElementById("foilOption").checked = false;
      
      generatedUrlText = "";
      preview.srcdoc = "";
      clearState();
      cardNameInput.focus();
    });

    // é€šå¸¸ã®ã‚³ãƒ”ãƒ¼ç”¨é–¢æ•°ï¼ˆãƒœã‚¿ãƒ³ã®HTMLæ§‹é€ ã‚’å£Šã•ãªã„ã‚ˆã†ã«ä¿®æ­£ï¼‰
    const copyToClipboard = async (text, button, label = "ã‚³ãƒ”ãƒ¼å®Œäº†") => {
      if (!text || !text.trim()) return;
      
      try { await navigator.clipboard.writeText(text); } catch (err) {}

      if (button) {
        const originalText = button.textContent;
        // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒã—ã¤ã¤ã€ä¸€æ™‚çš„ã«å¤‰æ›´
        button.textContent = label;
        button.style.background = "#22c55e"; 
        button.style.color = "#fff";
        button.style.borderColor = "#22c55e";
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = "";
          button.style.color = "";
          button.style.borderColor = "";
        }, 1200);
      }
    };

    copyResultBtn.addEventListener("click", async () => {
      await copyToClipboard(generatedUrlText, copyResultBtn, "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    });

    const restoreFromStorage = () => {
      const state = loadState();
      if (!state) return false;
      if (state.cardName) cardNameInput.value = state.cardName;
      if (Array.isArray(state.stores)) {
        state.stores.forEach((s) => {
          const cb = document.getElementById(`store-${s}`);
          if (cb) cb.checked = true;
        });
      }
      if (state.stock) document.getElementById("stockOption").value = state.stock;
      if (state.language) document.getElementById("languageOption").value = state.language;
      if (state.foil) document.getElementById("foilOption").checked = state.foil;
      return true;
    };

    if (restoreFromStorage()) {
      render();
    }
  </script>
</body>
</html>
